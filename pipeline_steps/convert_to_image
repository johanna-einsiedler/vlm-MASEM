#!/usr/bin/env python3
"""Convert PDFs in an intermediate dataset folder to per-page PNG images."""

from __future__ import annotations

import argparse
from pathlib import Path
import sys

ROOT = Path(__file__).resolve().parents[1]
if str(ROOT) not in sys.path:
    sys.path.insert(0, str(ROOT))

from document_parsing.utils import pdf_to_images

DATASET_MAP = {
    "tune": "tuning",
    "tuning": "tuning",
    "val": "validation",
    "validation": "validation",
    "eval": "eval",
}


def _resolve_dataset_name(raw_name: str) -> str:
    dataset = DATASET_MAP.get(raw_name)
    if dataset is None:
        raise ValueError(
            f"Unknown dataset '{raw_name}'. Expected one of: {', '.join(DATASET_MAP)}."
        )
    return dataset


def _convert_dataset(dataset_name: str, dpi: int) -> None:
    dataset = _resolve_dataset_name(dataset_name)
    input_root = Path("data/intermediate_data") / dataset
    output_root = Path("data/image_data") / dataset

    if not input_root.exists():
        raise FileNotFoundError(f"Input folder not found: {input_root}")

    pdf_paths = sorted(input_root.glob("*.pdf"))
    if not pdf_paths:
        raise FileNotFoundError(f"No PDFs found in {input_root}")

    for pdf_path in pdf_paths:
        images = pdf_to_images(str(pdf_path), dpi=dpi)
        if not images:
            continue

        pdf_output_dir = output_root / pdf_path.stem
        pdf_output_dir.mkdir(parents=True, exist_ok=True)

        for index, image in enumerate(images, start=1):
            output_path = pdf_output_dir / f"page{index}.png"
            image.save(output_path, format="PNG")


def main() -> None:
    parser = argparse.ArgumentParser(
        description=(
            "Convert PDFs in data/intermediate_data/<dataset> into PNGs stored under "
            "data/image_data/<dataset>/<pdf_name>/page1.png, page2.png, ..."
        )
    )
    parser.add_argument(
        "dataset",
        help="Dataset name: tune, val, eval (or tuning/validation).",
    )
    parser.add_argument(
        "--dpi",
        type=int,
        default=600,
        help="DPI to use when rendering PDF pages (default: 600).",
    )
    args = parser.parse_args()
    _convert_dataset(args.dataset, dpi=args.dpi)


if __name__ == "__main__":
    main()
